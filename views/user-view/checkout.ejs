<!DOCTYPE HTML>
<html>
	<head>
	<title>SHOE PLANET</title>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!-- favicon -->
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/128/1785/1785348.png">
	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700" rel="stylesheet">
	
	<!-- Animate.css -->
	<link rel="stylesheet" href="css/animate.css">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" href="css/icomoon.css">
	<!-- Ion Icon Fonts-->
	<link rel="stylesheet" href="css/ionicons.min.css">
	<!-- Bootstrap  -->
	<link rel="stylesheet" href="css/bootstrap.min.css">

	<!-- Magnific Popup -->
	<link rel="stylesheet" href="css/magnific-popup.css">

	<!-- Flexslider  -->
	<link rel="stylesheet" href="css/flexslider.css">

	<!-- Owl Carousel -->
	<link rel="stylesheet" href="css/owl.carousel.min.css">
	<link rel="stylesheet" href="css/owl.theme.default.min.css">
	
	<!-- Date Picker -->
	<link rel="stylesheet" href="css/bootstrap-datepicker.css">
	<!-- Flaticons  -->
	<link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">

	<!-- Theme style  -->
	<link rel="stylesheet" href="css/style.css">
	

	</head>
		
	<body style="font-weight: bolder;" >
   
    
				

		<div class="colorlib-product" style="padding-top: 0;" >
      <a href="/cart"><p><svg  xmlns="http://www.w3.org/2000/svg" width="16" height="12" fill="currentColor" class="bi bi-arrow-left ml-4 mt-2 " viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
      </svg>back</p></a>
			<div class="container">
				<div class="row row-pb-lg">
					<div class="col-sm-10 offset-md-1">
						<div class="process-wrap">
							<div class="process text-center active">
								<p><span>01</span></p>
								<h3>Shopping Cart</h3>
							</div>
							<div class="process text-center active">
								<p><span>02</span></p>
								<h3>Checkout</h3>
							</div>
							<div class="process text-center">
								<p><span>03</span></p>
								<h3>Order Complete</h3>
							</div>





							
						</div>
					</div>
				</div>
        <div class="col-sm-8">
          <form >
            <div  class="row form-group">
              <div   class="col-sm-9">
                <input style=" width: 70%; border: 2px solid rgb(114, 109, 109); border-radius: 5px; " type="text" name="quantity" id="coupon"  placeholder="Your Coupon Number..."> 
                <a  onclick="couponremove()" class="btn btn-danger">Remove</a> <p id="msg" ></p>
              </div>
             
              <div class="col-sm-3 ">
                <input type="button" onclick="applycoupon($('#coupon').val())" value="Apply Coupon" class="btn btn-info">
               
              </div> 
            </div>
          </form>
        </div>
				<form  id="checkout" action="">
				<div class="col-lg-8 float-right">
                    <h3>Billing Address</h3>
                    <hr>
                    <a href="/newadress?profile=0" class="btn btn-primary ">Add Address</a>
                    <br><br>
                    <% if(typeof data !=="undefined" ){%>
                        <div style="width:auto;height:auto" class="order_box">
                            <%data.adress.forEach((value,index)=>{%>
                            
                              <a  href="/deleteaddress?id=<%=index%>"><img width="25px" height="25px" class="float-right" src="/admin/imagies/delete.png" alt="delete"></a>   <a href="/editaddress?id=<%=index%>"><img class="float-right mr-2" width="25px" height="25px" src="/admin/imagies/edit.png" alt="Edit"></a> 
								<label class="form-check-label"  for="flexCheckDefault">
                 
                                <input class="form-check-input" name="adress" type="radio" value="<%= value.fname %>, <%= value.adress %>" id="flexCheckDefault" required> <br>
                                
                                    <%=value.fname%> <br>
                                    <%=value.adress%> <br>
                                    Ph : <%=value.mobile%>,
                                    <%=value.email%> <br>
                                    <%=value.pincode %>
                                </label>
                                <br>
                                <div style="display: flex;">
                                    <div>
                                        <a class="btn hero-btn" style="color: rgb(248, 246, 246);" href="/edit_address?id=<%=value._id%>">edit</a>
                                    </div>
                                    <div style="margin-left: 10px;">
                                        <a class="btn hero-btn" style="color: rgb(248, 246, 246);" href="/delete_address?id=<%=value._id%>">delete</a>
                                    </div>
                                </div>
                                <hr>
                            <% })%>
                        </div>
                    <% }%>
                </div>
				
					<div class="col-lg-4 ">
						<div class="row">
							<div class="col-md-12">
								<div class="cart-detail">
									<h2>Cart Total</h2>
									<ul>
										<li>
											<span>Subtotal</span> <span id="mt3y" ><%=total%></span>

											<ul>
												<% for(let i=0 ;i<products.length;i++){%>
												<li><span><%=products[i].count%> x <%=products[i].productId.name%></span> <span><%=products[i].productId.price*products[i].count%></span></li>
												<input type="hidden" name="product_id" value="products[i]._id" >
												<input type="hidden" name="product_count"  value="<%=products[i].count%>" >
																								
												<%}%>
												<input type="hidden" id="total1" value="<%=total%>" >
											</ul><li><span>Shipping</span> <span>$45.00</span></li>
                      <li><span>Discount</span><span id="mt4y" >00</span></li>

                      <li><span><span >Wallet</span><label><input style="margin-top: 7px;" name="wallet" type="checkbox" value="wallet"></label></span><span  >$<%=wallet.wallet%></span></li>
                      <li><span>Order Total</span>  <span id="mt2y" >$<%=total%></span></li>
                    
                    </ul>
										</li>
										
										
										
									</ul>
								</div>
						   </div>

						   <div class="w-100"></div>

						   <div class="col-md-12">
								<div class="cart-detail">
									<h2>Payment Method</h2>
									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
											   <label><input type="radio"  value="banktransfer" name="optradio"> Direct Bank Tranfer</label>
											</div>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
											   <label><input type="radio"  value="checksheet" name="optradio" > Check Payment</label>
											</div>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-12">
											<div class="radio">
											   <label><input type="radio" value="COD"  name="optradio"> Cash On Delivery</label>
											</div>
										</div>
									</div>
									<div class="form-group">
										<div class="col-md-12">
											<div class="checkbox">
											   <label><input type="checkbox" value=""> I have read and accept the terms and conditions</label>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12 text-center">
								<input type="submit"  class="btn btn-success" value="PLACE ORDER" >
						</div>
					</div>
				</div>
			</div>
		</div>
	</form>
			
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>


    <script>


function applycoupon(coupon) {

  const amount = document.getElementById("total1").value;
$.ajax({
  url: "/checkoutcoupen",
  data: {
    coupon: coupon,
    amount
  },
  method: "post",
  success: (response) => {

    if (response.user) {
     
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'This coupon already used!'
      })
    } else if (response.limit) {
      console.log("coupon limit exceeded");
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'coupon limit exceeded!'
      })
    } else if (response.status) {
      console.log("This coupon now not in use");
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'coupon limit exceeded!'
      })
    } else if (response.cartAmount) {
      console.log("You cant use the coupon...Buy more");
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'You cant use the coupon...Buy more'
      })
    } else if (response.date) {
      console.log("coupon date expired");
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'date expired!!!'
      })
    } else if (response.amountOkey) {
      console.log("discount granded");
      document.getElementById('mt4y').innerHTML = response.disAmount
      document.getElementById('mt2y').innerHTML = response.disTotal
      document.getElementById("total1").value = response.disTotal
      document.getElementById('mt3y').innerHTML = response.disTotal
    
    
      console.log("done");
      Swal.fire({
        position: 'center',
        icon: 'success',
        title: 'Discount redeemed',
        showConfirmButton: false,
        timer: 1500
      })
    } else if (response.invalid) {
      console.log("invalid coupon");
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'Invalid Coupon!!!'
      })
    }
  }
})
}






$("#checkout").submit((e)=>{
        const amount = document.getElementById("total1").value;
        console.log("hiii");
        console.log(amount);
        // const amount2 = document.getElementById("gt2").innerHTML;
        // const discount = document.getElementById("gt3").innerHTML;
        let address = $("input[name=adress]:checked").val();
        let payment = $("input[name=optradio]:checked").val();
        let wallet = $("input[name=wallet]:checked").val();
       
        e.preventDefault();
		
        $.ajax({
          url:"/checkout",
          method:"post",
          data:{
            amount:amount,
            adress:address,
            optradio:payment,
            wallet
          },
          success:(response)=>{
            if(response.success){
              location.href = "/order-complete";
            }else{
              razorpayPayment(response.order);
            }
          }
        })
	
      })
    
     
    
      function razorpayPayment(order){
    
              var options = {
                  "key": "rzp_test_EPM97YtygusiKT", // Enter the Key ID generated from the Dashboard
                  "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                  "currency": "INR",
                  "name": "TZ watches", //your business name
                  "description": "Test Transaction",
                  "image": "https://example.com/your_logo",
                  "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                  "handler": function (response){
                    
    // alert(response.razorpay_payment_id);
    // alert(response.razorpay_order_id);
    // alert(response.razorpay_signature)
                      verifyPayment(response, order);
                  },
                  "prefill": {
                      "name": "Gaurav Kumar", //your customer's name
                      "email": "gaurav.kumar@example.com",
                      "contact": "9000090000" 
                  },
                  "notes": {
                      "address": "Razorpay Corporate Office"
                  },
                  "theme": {
                      "color": "#3399cc"
                  }
              };
              var rzp1 = new Razorpay(options);
                  rzp1.open();
            }
      function verifyPayment(payment,order){
        const amount = document.getElementById("total1").value;
        // const amount2 = document.getElementById("gt2").innerHTML;
        $.ajax({
          url:"/verifyPayment",
          method:"post",
          data:{
            payment,
            amount,
            order
          },
          success:(response)=>{
            if(response.success){
              location.href = '/order-complete';
            }else{
              alert('payment failed');
              location.href = '/index';
            }
          }
        })
      }
      const newamount = document.getElementById("total1").value;
function couponremove(){
  Swal.fire({
            title:'Delete. are you sure!',
            text:"You want to remove this coupon!",
            icon:"warning",
            showCancelButton:'True',
            confirmButtonColor:"#3085d6",
            CancelButtonColor:'#d33',
            confirmButtonText:'Yes'
        }).then((result)=>{
          if(result.isConfirmed){
            $.ajax({
  url: "/removecoupen",
  method: "get",
  data: {
    newamount
  },success:(response)=>{
    if(response.success){
      location.reload()
    }
    
  }
      })
          }
        })

}
 

      </script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		<script src="sweetalert2.all.min.js"></script>
		<script src="sweetalert2.min.js"></script>
<link rel="stylesheet" href="sweetalert2.min.css">



		<%- include('../layout/footer2.ejs')%>

